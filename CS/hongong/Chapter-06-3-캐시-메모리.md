## 학습 키워드

- `저장 장치 계층 구조` `캐시 메모리` `캐시 적중률` `참조 지역성의 원리`
- 캐시 메모리의 탄생 배경과 특징, 작동 원리

---

# 저장 장치 계층 구조(memory hierarchy)

![](/CS/hongong/img/저장_장치_계층_구조.png)

- ‘빠른 저장 장치’와 ‘용량이 큰 저장 장치’는 양립하기 어렵다. 저장 장치는 아래와 같은 명제를 따르기 때문이다.
    
    ```
    1. CPU와 가까운 저장 장치는 빠르고, 멀리 있는 저장 장치는 느리다.
    2. 속도가 빠른 저장 장치는 저장 용량이 작고, 가격이 비싸다.
    ```
    
- 컴퓨터가 사용하는 저장 장치들은 ‘**CPU에 얼마나 가까운가**’를 기준으로 계층적으로 나타낼 수 있다. 이를 저장 장치 계층 구조라고 한다.
- 각기 다른 용량과 성능의 저장 장치들을 계층화하여 표현한 구조

## 저장 장치 계층 장단점

1. 레지스터
    - CPU와 가장 가까움
    - RAM보다 용량이 작음
    - 접근 시간이 압도적으로 빠름
    - 가격이 비쌈
2. RAM
    - USB 메모리보다 CPU에 더 가까움
    - USB 메모리보다 접근 시간이 빠름
    - 같은 용량이라도 USB 메모리보다 가격이 더 비쌈
3. 보조기억장치
    - CPU와 멀리 떨어져있음
    - 속도가 느림
    - 가격이 저렴함
- 각 저장 장치들의 장단점이 명확한데, 일반적으로 컴퓨터는 다양한 저장 장치를 모두 사용하게 된다.

# 캐시 메모리(cache memory)

![](/CS/hongong/img/캐시메모리_저장_장치_계층구조.png)

- CPU 연산 속도가 아무리 빨라도 메모리에 접근하는 속도가 그에 따라가지 못한다면 CPU의 발전은 소용이 없다. 그래서 등장한 저장 장치가 **캐시 메모리**이다.
- CPU와 메모리 사이에 위치하고, 레지스터보다 용량이 크고 메모리보다 빠른 SRAM 기반의 저장 장치
- 캐시 메모리는 CPU의 연산 속도와 메모리 접근 속도의 차이를 줄이기 위해 탄생하였다. 매모리에서 CPU가 사용할 일부 데이터를 캐시 메모리로 가지고 와서 활용하는 것

![](/CS/hongong/img/캐시메모리를_사용하는_경우.png)

## 캐시 메모리의 계층 구조

![](/CS/hongong/img/캐시메모리_계층구조.png)

- 컴퓨터 내부에는 여러 개의 캐시 메모리가 있다. 이 캐시 메모리들은 CPU와 가까운 순서대로 계층을 구성한다.
    - 일반적으로 L1 캐시와 L2 캐시는 코어 내부에, L3 캐시는 코어 외부에 위치해 있다.
- 코어와 가장 가까운 순서 - **L1(Level 1) 캐시** → **L2 캐시** → **L3 캐시** 순서
- 캐시 메모리의 용량 - L1 → L2 → L3 순으로 커짐
- 속도 - L3 → L2 → L1 순으로 빨라짐
- 가격 - L3 → L2 → L1 순으로 비쌈
- CPU가 메모리 내에 데이터가 필요하다고 판단하면 우선 L1 캐시에 해당 데이터가 있는지 보고, 없다면 L2, L3 캐시 순으로 데이터를 검색함

## 멀티 코어 프로세서에서 캐시 메모리의 계층 구조

![](/CS/hongong/img/멀티코어프로세서에서_캐시메모리_계층구조.png)

- L1 캐시와 L2 캐시는 코어마다 고유한 캐시 메모리로 할당되고, L3 캐시는 여러 코어가 공유하는 형태로 사용됨

## 저장 장치 계층 구조

![](/CS/hongong/img/저장장치계층구조_세부.png)

# 참조 지역성 원리

*캐시 메모리는 메모리에 있는 모든 내용을 가져다 저장할 수는 없다. 메모리가 보조기억장치의 일부를 복사하여 저장하는 것처럼 캐시 메모리는 메모리의 일부를 복사하여 저장한다. 그렇다면 캐시 메모리는 무엇을 저장해야 할까?*

- 보조기억장치는 전원이 꺼져도 기억할 대상을 저장
- 메모리는 실행 중인 대상을 저장
- 캐시 메모리는 CPU가 사용할 법한 대상을 예측하여 저장한다.

## 캐시 히트(cache hit)

- 자주 사용될 것으로 예측한 데이터가 실제로 들어맞아 캐시 메모리 내 데이터가 CPU에서 활용될 경우를 캐시 히트라고 한다.

## 캐시 미스(cache miss)

- 자주 사용될 것으로 예측하여 캐시 메모리에 저장했지만, 예측이 틀려 메모리에서 필요한 데이터를 직접 가져와야 하는 경우를 캐시 미스라고 한다.
- 캐시 미스가 발생하면 CPU가 필요한 데이터를 직접 가져와야 하기 때문에 캐시 메모리의 이점을 활용할 수 없다.

## 캐시 적중률(cache hit ratio)

- 캐시가 히트되는 비율
- 캐시 히트 횟수 / (캐시 히트 횟수 + 캐시 미스 횟수)
- 우리가 사용하는 컴퓨터의 캐시 적중률은 대략 85~95% 이상이다.

## 참조 지역성의 원리(locality of reference, principle of locality)

*캐시 메모리의 이점을 제대로 활용하려면 캐시 적중률을 높여야 한다. CPU가 사용할 법한 데이터는 어떻게 알 수 있을까?*

- 캐시 메모리는 참조 지역성의 원리에 따라 메모리로부터 가져올 데이터를 결정한다.
- **참조 지역성의 원리**란 CPU가 메모리에 접근할 때의 주된 경험을 바탕으로 만들어진 원리이다.
    
    ```
    1. CPU는 최근에 접근했던 메모리 공간에 다시 접근하려는 경향이 있다.
    2. CPU는 접근한 메모리 공간 근처를 접근하려는 경향이 있다.
    ```
    

### 1. 최근에 접근했던 메모리 공간에 다시 접근하려는 경향

- 변수에 저장된 값은 일반적으로 한 번만 사용되지 않고 프로그램이 실행되는 동안 여러 번 사용된다. 즉, CPU는 최근에 접근했던 (변수가 저장된) 메모리 공간을 여러 번 다시 접근할 수 있다.

```cpp
#include <stdio.h>

int main(void) {
	int num = 2;
	
	for(int i = 1; i<=9; i++) {
			printf("%d X %d = %d\n", num, i, num * i);
	}
	
	return 0;
}
```

- 코드에서 변수는 num 과 i 이다. 구구단 2단을 출력하는 과정에서 이 변수들이 여러 번 사용되고 있다.
- 이처럼 ‘최근에 접근했던 메모리 공간에 다시 접근하려는 경향’을 **시간 지역성**(temporal locality)이라고 한다.

### 2. 접근한 메모리 공간 근처를 접근하려는 경향

![](/CS/hongong/img/공간지역성.png)

- CPU가 실행하려는 프로그램은 보통 관련 데이터들끼리 한데 모여 있다. 여러 프로그램이 있을 때 이 프로그램은 서로 관련 있는 데이터끼리 모여서 저장된다.
- 하나의 프로그램 내에서도 관련 있는 데이터들은 모여서 저장된다. 
가령 워드프로세서 프로그램에 자동 저장 기능, 입력 기능, 출력 기능이 있다고 했을 때 각각의 기능과 관련한 데이터는 모여 저장된다.
- CPU가 워드 프로세서를 실행한다면?
    - 워드 프로세서 프로그램이 모여 있는 공간 근처를 집중적으로 접근한다.
    - 사용자가 입력을 한다면 입력 기능이 모여 있는 공간 근처를 집중적으로 접근하다.
- 이처럼 ‘접근한 메모리 공간 근처를 접근하려는 경향’을 **공간 지역성**(spatial locality)이라고 한다.

*캐시 메모리는 참조 지역성의 원리에 입각해 CPU가 사용할 법한 데이터를 예측한다.*